---
import Container from "../ui/Container.astro";
// import ThemeToggle from "./ThemeToggle.astro";
import LanguageSwitch from "./LanguageSwitch.astro";
import MobileMenu from "./MobileMenu.astro";

interface Props {
  navItems: { label: string; href: string }[];
}

const { navItems } = Astro.props;
---

<header id="main-header" class="header-premium">
  <Container class="header-container">
    <!-- Unified Super Pill Nav -->
    <nav class="desktop-nav">
      <div class="segmented-control">
        <!-- Logo Integrated on the left -->
        <a href="/" class="brand-logo" aria-label="Quantix Software Home">
          <svg
            class="logo"
            width="130"
            height="36"
            viewBox="0 0 140 40"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect width="40" height="40" rx="10" fill="var(--primary)"></rect>
            <path d="M20 10L30 20L20 30L10 20L20 10Z" fill="white"></path>
            <text
              x="50"
              y="27"
              font-family="var(--font-heading)"
              font-size="24"
              font-weight="bold"
              fill="white">Quantix</text
            >
          </svg>
        </a>

        <div class="nav-pill-separator"></div>

        <!-- Links -->
        <div class="nav-links-wrapper">
          <div id="nav-indicator" class="nav-indicator"></div>
          {
            navItems.map((item) => (
              <a
                href={item.href}
                class="nav-link"
                data-target={item.href.split("#")[1]}
              >
                {item.label}
              </a>
            ))
          }
        </div>

        <div class="nav-pill-separator"></div>

        <!-- Settings Integrated on the right -->
        <div class="nav-settings-integrated">
          <!-- <ThemeToggle />  Por el momento estará en hide -->
          <LanguageSwitch />
        </div>
      </div>
    </nav>

    <!-- Mobile Header (Logo stays visible) -->
    <div class="mobile-header mobile-only">
      <a href="/" class="brand-logo-mobile">
        <svg
          width="32"
          height="32"
          viewBox="0 0 32 32"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect width="32" height="32" rx="8" fill="var(--primary)"></rect>
          <path d="M16 8L24 16L16 24L8 16L16 8Z" fill="white"></path>
        </svg>
      </a>

      <button
        id="mobile-menu-toggle"
        class="mobile-toggle"
        aria-label="Abrir menú"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </Container>
</header>

<MobileMenu navItems={navItems} />

<style>
  .header-premium {
    position: fixed;
    top: 0;
    z-index: 50;
    width: 100%;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    padding: var(--space-6) 0;
    background: transparent;
  }

  @media (max-width: 1023px) {
    .header-premium {
      position: absolute; /* Not fixed on mobile to avoid blocking content */
      padding: var(--space-4) 0;
    }
  }

  /* Scrolled State (Transparent global bar, Pill becomes distinct) */
  .header-premium.scrolled {
    background: transparent;
    border-bottom: none;
    padding: var(--space-4) 0;
    box-shadow: none;
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: center; /* Center horizontally */
    width: 100%;
    position: relative;
    padding: 0 var(--space-4);
  }

  /* Super Pill - Unified Navigation */
  .segmented-control {
    display: flex;
    align-items: center;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05); /* Pro glass background */
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    position: relative;
    margin: 0 auto; /* Extra centering safety */
    box-shadow:
      0 10px 40px rgba(0, 0, 0, 0.2),
      inset 0 1px 1px rgba(255, 255, 255, 0.1);
  }

  .brand-logo {
    display: flex;
    align-items: center;
    padding-left: var(--space-2);
    transition: transform 0.3s ease;
  }

  .brand-logo:hover {
    transform: scale(1.05);
  }

  .logo {
    width: 130px;
    height: 36px;
  }
  /* Scrolled state: High contrast backplate for navigation */
  .header-premium.scrolled .segmented-control {
    background: var(--surface); /* Use solid theme surface */
    border-color: var(--border-strong);
    box-shadow:
      var(--shadow-lg),
      0 0 20px rgba(0, 0, 0, 0.05);
  }

  .nav-links-wrapper {
    display: flex;
    position: relative;
    align-items: center;
  }

  /* Visibility Logic */
  .desktop-nav {
    display: none; /* Hidden on mobile */
  }

  .mobile-header {
    display: flex;
    width: 100%;
    max-width: 450px; /* Slimmer for better center focus */
    justify-content: space-between;
    align-items: center;
    padding: 6px 16px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    margin: 0 auto; /* Pure centering */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  .header-premium.scrolled .mobile-header {
    background: var(--surface-1);
    border-color: var(--border);
  }

  /* Desktop View Refresh - Hide Mobile Header */
  @media (min-width: 1024px) {
    .desktop-nav {
      display: flex;
    }

    .mobile-header {
      display: none;
    }

    .header-premium {
      padding: var(--space-6) 0;
    }
  }

  /* Link Styles (Used in Pill) */
  .nav-link {
    position: relative;
    z-index: 2;
    padding: 10px 24px;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.7); /* White at top of hero */
    font-size: var(--text-sm);
    font-weight: 600;
    transition: all 0.3s ease;
    border-radius: 9999px;
  }

  .nav-link:hover {
    color: #ffffff;
  }
  .nav-link.active {
    color: white;
  }

  /* Scroll State: Adapt to theme background */
  .header-premium.scrolled .nav-link {
    color: var(--text-muted);
  }
  .header-premium.scrolled .nav-link:hover {
    color: var(--text);
  }
  .header-premium.scrolled .nav-link.active {
    color: var(--primary);
  }

  /* Glider Animation (The 'Indicator') */
  .nav-indicator {
    position: absolute;
    top: 4px;
    bottom: 4px;
    left: 0;
    width: 0;
    background: rgba(255, 255, 255, 0.2); /* Subtle glass at top */
    border-radius: 9999px;
    z-index: 1;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  .nav-indicator.visible {
    opacity: 1;
  }

  /* Scrolled indicator: More prominent and theme-aware */
  .header-premium.scrolled .nav-indicator {
    background: var(--surface);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
  }

  /* Text color inside glided link must contrast against white indicator if light mode... 
     For simple elegance, usually the indicator is white/surface and text uses primary color 
     We already set .active color above. */

  .nav-pill-separator {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.15);
    margin: 0 8px;
    flex-shrink: 0;
  }

  .header-premium.scrolled .nav-pill-separator {
    background: var(--border-strong);
    height: 20px;
  }

  .nav-settings-integrated {
    display: flex;
    align-items: center;
    gap: 2px;
    z-index: 10;
    padding-right: 4px;
  }

  /* Reducir íconos para que quepan mejor en el nav */
  .nav-settings-integrated :global(.theme-toggle),
  .nav-settings-integrated :global(.lang-switch) {
    padding: 6px 8px !important;
    background: transparent !important;
  }

  /* Override internal items for Capsule Context */
  .header-premium :global(.theme-toggle),
  .header-premium :global(.lang-switch) {
    padding: 6px 10px; /* Tighter padding for capsule */
    border-radius: 999px;
  }

  /* Actions Colors Override at top (Transparent Header) */
  .header-premium:not(.scrolled) :global(.theme-toggle),
  .header-premium:not(.scrolled) :global(.lang-switch) {
    color: rgba(255, 255, 255, 0.9);
  }

  .header-premium:not(.scrolled) :global(.theme-toggle:hover),
  .header-premium:not(.scrolled) :global(.lang-switch:hover) {
    color: white;
    background-color: rgba(255, 255, 255, 0.1);
  }

  .header-premium:not(.scrolled) :global(.lang-code.active) {
    color: white;
  }

  /* Scrolled State Overrides */
  .header-premium.scrolled :global(.theme-toggle),
  .header-premium.scrolled :global(.lang-switch) {
    color: var(--text-muted);
  }

  .header-premium.scrolled :global(.theme-toggle:hover),
  .header-premium.scrolled :global(.lang-switch:hover) {
    color: var(--text);
    background-color: var(--surface-3);
  }

  /* Mobile Styles */
  .mobile-header {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
    padding: 0 var(--space-4);
  }

  .brand-logo-mobile {
    display: flex;
    align-items: center;
  }

  /* Logo adjustment for white/dark */
  .header-premium.scrolled .brand-logo :global(text) {
    fill: var(--text); /* Restore theme text color on scroll */
  }

  .header-premium:not(.scrolled) .brand-logo :global(path) {
    fill: white; /* Force white text in logo at top */
  }
  .header-premium.scrolled .brand-logo :global(path) {
    fill: var(--text); /* Restore theme text color on scroll */
  }
  .header-premium.scrolled .brand-logo :global(rect) {
    fill: var(--primary);
  }

  .mobile-toggle {
    background: none;
    border: none;
    color: white; /* White at top */
    padding: var(--space-2);
    cursor: pointer;
    transition: color 0.3s;
  }

  .header-premium.scrolled .mobile-toggle {
    color: var(--text);
  }

  .desktop-only {
    display: none;
  }
  .mobile-only {
    display: flex;
  }

  @media (min-width: 1024px) {
    .desktop-nav {
      display: flex;
    }
    .desktop-only {
      display: flex;
    }
    .mobile-only {
      display: none;
    }
  }
</style>

<script>
  function setupHeader() {
    // Scroll Effect
    const header = document.getElementById("main-header");
    window.addEventListener("scroll", () => {
      if (window.scrollY > 20) {
        header?.classList.add("scrolled");
      } else {
        header?.classList.remove("scrolled");
      }
    });

    // Mobile Menu Toggle
    const toggleBtn = document.getElementById("mobile-menu-toggle");
    const overlay = document.getElementById("mobile-menu-overlay");

    toggleBtn?.addEventListener("click", () => {
      overlay?.classList.add("open");
      document.body.style.overflow = "hidden";
    });

    // Segmented Control Indicator (Simple client side implementation)
    const links = document.querySelectorAll(".nav-link");
    const indicator = document.getElementById("nav-indicator");

    function updateIndicator(targetLink: Element | null) {
      if (!targetLink || !indicator) return;

      const linkRect = targetLink.getBoundingClientRect();
      const parentRect = targetLink.parentElement!.getBoundingClientRect();

      indicator.style.width = `${linkRect.width}px`;
      indicator.style.transform = `translateX(${linkRect.left - parentRect.left}px)`;
      indicator.classList.add("visible");

      // Update Active text class
      links.forEach((l) => l.classList.remove("active"));
      targetLink.classList.add("active");
    }

    // Init active state based on URL hash if possible or first item
    /* Nota: Esto es ideal para One Page.
       Si estamos en una página externa, quizás no queramos marcar nada o marcar un item "Productos"
       si hacemos match con la ruta.
    */

    links.forEach((link) => {
      link.addEventListener("mouseenter", () => {
        // Hover effect optional: mover indicador al hover?
        // updateIndicator(link);
      });

      link.addEventListener("click", () => {
        updateIndicator(link);
      });
    });

    // Intersection Observer for Scroll Spy
    const observerOptions = {
      root: null,
      rootMargin: "-20% 0px -60% 0px", // Trigger when section is near top
      threshold: 0,
    };

    const spyObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute("id");
          if (!id) return;

          const targetLink = document.querySelector(
            `.nav-link[data-target="${id}"]`,
          );
          if (targetLink) {
            updateIndicator(targetLink);
          }
        }
      });
    }, observerOptions);

    document.querySelectorAll("section[id]").forEach((section) => {
      spyObserver.observe(section);
    });
  }

  setupHeader();
  document.addEventListener("astro:page-load", setupHeader);
</script>
